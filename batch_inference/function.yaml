kind: job
metadata:
  name: batch-inference
  tag: ''
  hash: 98c2b3843338265f6d05b59c152ee935f492ead3
  project: ''
  labels:
    author: guyl
  categories:
  - utils
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IGhhc2hsaWIKaW1wb3J0IGpzb24KZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSB0eXBpbmcgaW1wb3J0IEFueSwgRGljdCwgTGlzdCwgVHVwbGUsIFVuaW9uCgppbXBvcnQgbWxydW4KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBtbHJ1biBpbXBvcnQgZmVhdHVyZV9zdG9yZSBhcyBmcwpmcm9tIG1scnVuLmFwaS5zY2hlbWFzIGltcG9ydCBPYmplY3RLaW5kCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBBcnRpZmFjdApmcm9tIG1scnVuLmRhdGFfdHlwZXMuaW5mZXIgaW1wb3J0IEluZmVyT3B0aW9ucywgZ2V0X2RmX3N0YXRzCmZyb20gbWxydW4uZnJhbWV3b3Jrcy5hdXRvX21scnVuIGltcG9ydCBBdXRvTUxSdW4KZnJvbSBtbHJ1bi5tb2RlbF9tb25pdG9yaW5nLmZlYXR1cmVzX2RyaWZ0X3RhYmxlIGltcG9ydCBGZWF0dXJlc0RyaWZ0VGFibGVQbG90CmZyb20gbWxydW4ubW9kZWxfbW9uaXRvcmluZy5tb2RlbF9tb25pdG9yaW5nX2JhdGNoIGltcG9ydCAoCiAgICBWaXJ0dWFsRHJpZnQsCiAgICBjYWxjdWxhdGVfaW5wdXRzX3N0YXRpc3RpY3MsCikKCiMgQSB1bmlvbiBvZiBhbGwgc3VwcG9ydGVkIGRhdGFzZXQgdHlwZXM6CkRhdGFzZXRUeXBlID0gVW5pb25bbWxydW4uRGF0YUl0ZW0sIGxpc3QsIGRpY3QsIHBkLkRhdGFGcmFtZSwgcGQuU2VyaWVzLCBucC5uZGFycmF5XQoKCmRlZiBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgIGRhdGFzZXQ6IERhdGFzZXRUeXBlLAogICAgbGFiZWxfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl1dID0gTm9uZSwKICAgIGRyb3BfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl0sIGludCwgTGlzdFtpbnRdXSA9IE5vbmUsCikgLT4gVHVwbGVbcGQuRGF0YUZyYW1lLCBMaXN0W3N0cl1dOgogICAgIiIiCiAgICBQYXJzZSB0aGUgZ2l2ZW4gZGF0YXNldCBpbnRvIGEgRGF0YUZyYW1lIGFuZCBkcm9wIHRoZSBjb2x1bW5zIGFjY29yZGluZ2x5LiBJbiBhZGRpdGlvbiwgdGhlIGxhYmVsIGNvbHVtbnMgd2lsbCBiZQogICAgcGFyc2VkIGFuZCB2YWxpZGF0ZWQgYXMgd2VsbC4KCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgVGhlIGRhdGFzZXQgdG8gdHJhaW4gdGhlIG1vZGVsIG9uLgogICAgICAgICAgICAgICAgICAgICAgICAgIENhbiBiZSBlaXRoZXIgYSBsaXN0IG9mIGxpc3RzLCBkaWN0LCBVUkkgb3IgYSBGZWF0dXJlVmVjdG9yLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbnM6IFRoZSB0YXJnZXQgbGFiZWwocykgb2YgdGhlIGNvbHVtbihzKSBpbiB0aGUgZGF0YXNldC4gZm9yIFJlZ3Jlc3Npb24gb3IKICAgICAgICAgICAgICAgICAgICAgICAgICBDbGFzc2lmaWNhdGlvbiB0YXNrcy4KICAgIDpwYXJhbSBkcm9wX2NvbHVtbnM6ICBgYHN0cmBgIC8gYGBpbnRgYCBvciBhIGxpc3Qgb2YgYGBzdHJgYCAvIGBgaW50YGAgdGhhdCByZXByZXNlbnQgdGhlIGNvbHVtbiBuYW1lcyAvIGluZGljZXMgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICBkcm9wLgoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgogICAgICAgICAgICAgIFswXSA9IFRoZSBwYXJzZWQgZGF0YXNldCBhcyBhIERhdGFGcmFtZQogICAgICAgICAgICAgIFsxXSA9IExhYmVsIGNvbHVtbnMuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBgZHJvcF9jb2x1bW5zYCBhcmUgbm90IG1hdGNoaW5nIHRoZSBkYXRhc2V0IG9yIHVuc3VwcG9ydGVkIGRhdGFzZXQgdHlwZS4KICAgICIiIgogICAgIyBUdXJuIHRoZSBgZHJvcCBsYWJlbHNgIGludG8gYSBsaXN0IGlmIGdpdmVuOgogICAgaWYgZHJvcF9jb2x1bW5zIGlzIG5vdCBOb25lOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGRyb3BfY29sdW1ucywgbGlzdCk6CiAgICAgICAgICAgIGRyb3BfY29sdW1ucyA9IFtkcm9wX2NvbHVtbnNdCgogICAgIyBDaGVjayBpZiB0aGUgZGF0YXNldCBpcyBpbiBmYWN0IGEgRmVhdHVyZSBWZWN0b3I6CiAgICBpZiBkYXRhc2V0Lm1ldGEgYW5kIGRhdGFzZXQubWV0YS5raW5kID09IE9iamVjdEtpbmQuZmVhdHVyZV92ZWN0b3I6CiAgICAgICAgIyBUcnkgdG8gZ2V0IHRoZSBsYWJlbCBjb2x1bW5zIGlmIG5vdCBwcm92aWRlZDoKICAgICAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBkYXRhc2V0Lm1ldGEuc3RhdHVzLmxhYmVsX2NvbHVtbgogICAgICAgICMgR2V0IHRoZSBmZWF0dXJlcyBhbmQgcGFyc2UgdG8gRGF0YUZyYW1lOgogICAgICAgIGRhdGFzZXQgPSBmcy5nZXRfb2ZmbGluZV9mZWF0dXJlcygKICAgICAgICAgICAgZGF0YXNldC5tZXRhLnVyaSwgZHJvcF9jb2x1bW5zPWRyb3BfY29sdW1ucwogICAgICAgICkudG9fZGF0YWZyYW1lKCkKICAgIGVsc2U6CiAgICAgICAgIyBQYXJzZSB0byBEYXRhRnJhbWUgYWNjb3JkaW5nIHRvIHRoZSBkYXRhc2V0J3MgdHlwZToKICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGFzZXQsIChsaXN0LCBucC5uZGFycmF5KSk6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIGxpc3QgLyBudW1weSBhcnJheSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgICMgVmFsaWRhdGUgdGhlIGBkcm9wX2NvbHVtbnNgIGlzIGdpdmVuIGFzIGludGVnZXJzOgogICAgICAgICAgICBpZiBkcm9wX2NvbHVtbnMgYW5kIG5vdCBhbGwoaXNpbnN0YW5jZShjb2wsIGludCkgZm9yIGNvbCBpbiBkcm9wX2NvbHVtbnMpOgogICAgICAgICAgICAgICAgcmFpc2UgbWxydW4uZXJyb3JzLk1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3IoCiAgICAgICAgICAgICAgICAgICAgImBkcm9wX2NvbHVtbnNgIG11c3QgYmUgYW4gaW50ZWdlciAvIGxpc3Qgb2YgaW50ZWdlcnMgaWYgcHJvdmlkZWQgYXMgYSBsaXN0LiIKICAgICAgICAgICAgICAgICkKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGF0YXNldCwgbWxydW4uRGF0YUl0ZW0pOgogICAgICAgICAgICAjIFR1cm4gdGhlIERhdGFJVGVtIHRvIERhdGFGcmFtZToKICAgICAgICAgICAgZGF0YXNldCA9IGRhdGFzZXQuYXNfZGYoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIG9iamVjdCAoc2hvdWxkIGJlIGEgcGQuRGF0YUZyYW1lIC8gcGQuU2VyaWVzLCBkaWN0aW9uYXJ5KSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgICAgICAgICBmIkNvdWxkIG5vdCBwYXJzZSB0aGUgZ2l2ZW4gZGF0YXNldCBvZiB0eXBlIHt0eXBlKGRhdGFzZXQpfSBpbnRvIGEgcGFuZGFzIERhdGFGcmFtZS4gIgogICAgICAgICAgICAgICAgICAgIGYiUmVjZWl2ZWQgdGhlIGZvbGxvd2luZyBlcnJvcjoge2V9IgogICAgICAgICAgICAgICAgKQogICAgICAgICMgRHJvcCBjb2x1bW5zIGlmIG5lZWRlZDoKICAgICAgICBpZiBkcm9wX2NvbHVtbnM6CiAgICAgICAgICAgIGRhdGFzZXQuZHJvcChkcm9wX2NvbHVtbnMsIGF4aXM9MSwgaW5wbGFjZT1UcnVlKQoKICAgICMgVHVybiB0aGUgYGxhYmVsX2NvbHVtbnNgIGludG8gYSBsaXN0IGJ5IGRlZmF1bHQ6CiAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtdCiAgICBlbGlmIGlzaW5zdGFuY2UobGFiZWxfY29sdW1ucywgKHN0ciwgaW50KSk6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtsYWJlbF9jb2x1bW5zXQoKICAgIHJldHVybiBkYXRhc2V0LCBsYWJlbF9jb2x1bW5zCgoKZGVmIF9wcmVwYXJlX3Jlc3VsdF9zZXQoCiAgICB4OiBwZC5EYXRhRnJhbWUsIGxhYmVsX2NvbHVtbnM6IExpc3Rbc3RyXSwgeV9wcmVkOiBucC5uZGFycmF5CikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBTZXQgZGVmYXVsdCBsYWJlbCBjb2x1bW4gbmFtZXMgYW5kIHZhbGlkYXRlIGdpdmVuIG5hbWVzIHRvIHByZXBhcmUgdGhlIHJlc3VsdCBzZXQgLSBhIGNvbmNhdGVuYXRpb24gb2YgdGhlIGlucHV0cwogICAgKHgpIGFuZCB0aGUgbW9kZWwgcHJlZGljdGlvbnMgKHlfcHJlZCkuCgogICAgOnBhcmFtIHg6ICAgICAgICAgICAgIFRoZSBpbnB1dHMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogQSBsaXN0IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgY29sdW1uIG5hbWVzIHRvIGFkZCB0byB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHQgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgdXNlZCBpbiBjYXNlIHRoZSBsaXN0IGlzIGVtcHR5IChwcmVkaWN0ZWRfbGFiZWxfe2l9KS4KICAgIDpwYXJhbSB5X3ByZWQ6ICAgICAgICBUaGUgbW9kZWwgcHJlZGljdGlvbnMgb24gdGhlIGlucHV0cy4KCiAgICA6cmV0dXJuczogVGhlIHJlc3VsdCBzZXQuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBsYWJlbHMgY29sdW1ucyBhbW91bnQgZG8gbm90IG1hdGNoIHRoZSBvdXRwdXRzIG9yIGlmIG9uZSBvZiB0aGUgbGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uIGFscmVhZHkgZXhpc3RzIGluIHRoZSBkYXRhc2V0LgogICAgIiIiCiAgICAjIFByZXBhcmUgZGVmYXVsdCB0YXJnZXQgY29sdW1ucyBuYW1lcyBpZiBub3QgcHJvdmlkZWQ6CiAgICBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID0gMSBpZiBsZW4oeV9wcmVkLnNoYXBlKSA9PSAxIGVsc2UgeV9wcmVkLnNoYXBlWzFdCiAgICBpZiBsZW4obGFiZWxfY29sdW1ucykgPT0gMDoKICAgICAgICAjIEFkZCBkZWZhdWx0IGxhYmVsIGNvbHVtbiBuYW1lczoKICAgICAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID09IDE6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBbInByZWRpY3RlZF9sYWJlbCJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgICAgIGYicHJlZGljdGVkX2xhYmVsX3tpfSIgZm9yIGkgaW4gcmFuZ2UocHJlZGljdGlvbl9jb2x1bW5zX2Ftb3VudCkKICAgICAgICAgICAgXQoKICAgICMgVmFsaWRhdGUgdGhlIGxhYmVsIGNvbHVtbnM6CiAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ICE9IGxlbihsYWJlbF9jb2x1bW5zKToKICAgICAgICAjIE5vIGVxdWFsaXR5IGJldHdlZW4gcHJvdmlkZWQgbGFiZWwgY29sdW1uIG5hbWVzIGFuZCBvdXRwdXRzIGFtb3VudDoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbnVtYmVyIG9mIHByZWRpY3RlZCBsYWJlbHM6IHtwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50fSAiCiAgICAgICAgICAgIGYiaXMgbm90IGVxdWFsIHRvIHRoZSBnaXZlbiBsYWJlbCBjb2x1bW5zOiB7bGVuKGxhYmVsX2NvbHVtbnMpfSIKICAgICAgICApCiAgICBjb21tb25fbGFiZWxzID0gc2V0KGxhYmVsX2NvbHVtbnMpICYgc2V0KHguY29sdW1ucy50b2xpc3QoKSkKICAgIGlmIGNvbW1vbl9sYWJlbHM6CiAgICAgICAgIyBMYWJlbCBjb2x1bW4gZXhpc3QgaW4gdGhlIG9yaWdpbmFsIGlucHV0czoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbGFiZWxzOiB7Y29tbW9uX2xhYmVsc30gYXJlIGFscmVhZHkgZXhpc3RlZCBpbiB0aGUgZ2l2ZW4gZGF0YXNldC4iCiAgICAgICAgKQoKICAgIHJldHVybiBwZC5jb25jYXQoCiAgICAgICAgW3gsIHBkLkRhdGFGcmFtZSh5X3ByZWQsIGNvbHVtbnM9bGFiZWxfY29sdW1ucywgaW5kZXg9eC5pbmRleCldLCBheGlzPTEKICAgICkKCgpkZWYgX3BhcnNlX3dlaWdodHMoCiAgICBmZWF0dXJlczogTGlzdFtzdHJdLCBsYWJlbHM6IExpc3Rbc3RyXSwgd2VpZ2h0czogRGljdFtzdHIsIGZsb2F0XQopIC0+IERpY3Rbc3RyLCBmbG9hdF06CiAgICAiIiIKICAgIFBhcnNlIHRoZSBnaXZlbiB3ZWlnaHRzIHNvIG1pc3NpbmcgZmVhdHVyZXMgd2lsbCBiZSAwLjAgb3IgaWYgbm90IGdpdmVuLCBhIGRlZmF1bHQgd2VpZ2h0cyB3aWxsIGJlIGFzc2lnbmVkLgoKICAgIDpwYXJhbSBmZWF0dXJlczogTGlzdCBvZiBmZWF0dXJlcy4KICAgIDpwYXJhbSBsYWJlbHM6ICAgTGlzdCBvZiBsYWJlbHMuCiAgICA6cGFyYW0gd2VpZ2h0czogIFRoZSB1c2VyJ3Mgd2VpZ2h0cy4KCiAgICA6cmV0dXJuczogVGhlIHBhcnNlZCB3ZWlnaHRzLgogICAgIiIiCiAgICAjIElmIG5vIHdlaWdodHMgYXJlIGdpdmVuLCBtYWtlIHdlaWdodHMgYWxsIGVxdWFsICh0byByZXByZXNlbnQgYSBzaW1wbGUgYXZlcmFnZSk6CiAgICBpZiB3ZWlnaHRzIGlzIE5vbmU6CiAgICAgICAgZmVhdHVyZV93ZWlnaHQgPSAxIC8gbGVuKGZlYXR1cmVzKQogICAgICAgIGxhYmVsX3dlaWdodCA9IDEgLyBsZW4obGFiZWxzKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICoqe2ZlYXR1cmU6IGZlYXR1cmVfd2VpZ2h0IGZvciBmZWF0dXJlIGluIGZlYXR1cmVzfSwKICAgICAgICAgICAgKip7bGFiZWw6IGxhYmVsX3dlaWdodCBmb3IgbGFiZWwgaW4gbGFiZWxzfSwKICAgICAgICB9CgogICAgIyBaZXJvIG91dCBtaXNzaW5nIGZlYXR1cmVzIGFuZCBsYWJlbHM6CiAgICBmb3IgcG9zc2libGVfd2VpZ2h0X2tleXMgaW4gW2ZlYXR1cmVzLCBsYWJlbHNdOgogICAgICAgIGZvciBrZXkgaW4gcG9zc2libGVfd2VpZ2h0X2tleXM6CiAgICAgICAgICAgIGlmIGtleSBub3QgaW4gd2VpZ2h0czoKICAgICAgICAgICAgICAgIHdlaWdodHNba2V5XSA9IDAuMAogICAgcmV0dXJuIHdlaWdodHMKCgpkZWYgX2dldF9zYW1wbGVfc2V0X3N0YXRpc3RpY3MoCiAgICBzYW1wbGVfc2V0OiBEYXRhc2V0VHlwZSA9IE5vbmUsIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHM6IGRpY3QgPSBOb25lCikgLT4gZGljdDoKICAgICIiIgogICAgR2V0IHRoZSBzYW1wbGUgc2V0IHN0YXRpc3RpY3MgZWl0aGVyIGZyb20gdGhlIGdpdmVuIHNhbXBsZSBzZXQgb3IgdGhlIHN0YXRpc3RpY3MgbG9nZ2VkIHdpdGggdGhlIG1vZGVsIHdoaWxlCiAgICBmYXZvcmluZyB0aGUgZ2l2ZW4gc2FtcGxlIHNldC4KCiAgICA6cGFyYW0gc2FtcGxlX3NldDogICAgICAgICAgICAgICAgICAgQSBzYW1wbGUgZGF0YXNldCB0byBnaXZlIHRvIGNvbXBhcmUgdGhlIGlucHV0cyBpbiB0aGUgZHJpZnQgYW5hbHlzaXMuCiAgICA6cGFyYW0gbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0czogVGhlIGBmZWF0dXJlX3N0YXRzYCBhdHRyaWJ1dGUgaW4gdGhlIHNwZWMgb2YgdGhlIG1vZGVsIGFydGlmYWN0LCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbCBzYW1wbGUgc2V0IHN0YXRpc3RpY3Mgb2YgdGhlIG1vZGVsIHdhcyB1c2VkLgoKICAgIDpyZXR1cm5zOiBUaGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzLgoKICAgIHJhaXNlcyBNTFJ1bkludmFsaWRBcmd1bWVudEVycm9yOiBJZiBubyBzYW1wbGUgc2V0IG9yIHN0YXRpc3RpY3Mgd2VyZSBnaXZlbi4KICAgICIiIgogICAgIyBDaGVjayBpZiBhIHNhbXBsZSBzZXQgd2FzIHByb3ZpZGVkOgogICAgaWYgc2FtcGxlX3NldCBpcyBOb25lOgogICAgICAgICMgQ2hlY2sgaWYgdGhlIG1vZGVsIHdhcyBsb2dnZWQgd2l0aCBhIHNhbXBsZSBzZXQ6CiAgICAgICAgaWYgbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0cyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgICAgICJDYW5ub3QgcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBhcyB0aGVyZSBpcyBubyBzYW1wbGUgc2V0IHRvIGNvbXBhcmUgdG8uIFRoZSBtb2RlbCBhcnRpZmFjdCB3YXMgbm90ICIKICAgICAgICAgICAgICAgICJsb2dnZWQgd2l0aCBhIHNhbXBsZSBzZXQgYW5kIGBzYW1wbGVfc2V0YCB3YXMgbm90IHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbi4iCiAgICAgICAgICAgICkKICAgICAgICAjIFJldHVybiB0aGUgc3RhdGlzdGljcyBsb2dnZWQgd2l0aCB0aGUgbW9kZWw6CiAgICAgICAgcmV0dXJuIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHMKCiAgICAjIFR1cm4gdGhlIERhdGFJdGVtIHRvIERhdGFGcmFtZToKICAgIGlmIGlzaW5zdGFuY2Uoc2FtcGxlX3NldCwgbWxydW4uRGF0YUl0ZW0pOgogICAgICAgIHNhbXBsZV9zZXQsIF8gPSBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZShkYXRhc2V0PXNhbXBsZV9zZXQpCgogICAgIyBSZXR1cm4gdGhlIHNhbXBsZSBzZXQgc3RhdGlzdGljczoKICAgIHJldHVybiBnZXRfZGZfc3RhdHMoZGY9c2FtcGxlX3NldCwgb3B0aW9ucz1JbmZlck9wdGlvbnMuSGlzdG9ncmFtKQoKCmRlZiBfY2FsY3VsYXRlX2ZpbmFsX3Njb3JlKAogICAgY29sdW1ucywgZHJpZnRfcmVzdWx0cywgd2VpZ2h0cywgdGhyZXNob2xkCikgLT4gVHVwbGVbZmxvYXQsIGJvb2xdOgogICAgIiIiCiAgICBDYWxjdWxhdGUgdGhlIGZpbmFsIGRyaWZ0IHJlc3VsdCBvbiB0aGUgc3BlY2lmaWVkIGNvbHVtbnMuCgogICAgOnBhcmFtIGNvbHVtbnM6ICAgICAgIFRoZSBjb2x1bW5zIHRvIGluY2x1ZGUgaW4gdGhlIGZpbmFsIHNjb3JlLgogICAgOnBhcmFtIGRyaWZ0X3Jlc3VsdHM6IFRoZSBjb2x1bW5zIHJlc3VsdHMuCiAgICA6cGFyYW0gd2VpZ2h0czogICAgICAgVGhlIHdlaWdodHMgdG8gdXNlLgogICAgOnBhcmFtIHRocmVzaG9sZDogICAgIFRoZSB0aHJlc2hvbGQgZnJvbSB3aGljaCB0aGUgdmFsdWUgaXMgY29uc2lkZXJlZCBhIGRyaWZ0LgoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgogICAgICAgICAgICAgIFswXSA9IFRoZSByZXN1bHQuCiAgICAgICAgICAgICAgWzFdID0gQm9vbGVhbiB2YWx1ZSBhcyB0aGUgZHJpZnQgc3RhdHVzLgogICAgIiIiCiAgICByZXN1bHQgPSBzdW0oZHJpZnRfcmVzdWx0c1tjb2x1bW5dICogd2VpZ2h0c1tjb2x1bW5dIGZvciBjb2x1bW4gaW4gY29sdW1ucykKICAgIGlmIHJlc3VsdCA8IHRocmVzaG9sZDoKICAgICAgICByZXR1cm4gcmVzdWx0LCBGYWxzZQogICAgcmV0dXJuIHJlc3VsdCwgVHJ1ZQoKCmRlZiBfcGVyZm9ybV9kcmlmdF9hbmFseXNpcygKICAgIGZlYXR1cmVzOiBMaXN0W3N0cl0sCiAgICBsYWJlbHM6IExpc3Rbc3RyXSwKICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljczogZGljdCwKICAgIGlucHV0czogcGQuRGF0YUZyYW1lLAogICAgd2VpZ2h0czogRGljdFtzdHIsIGZsb2F0XSwKICAgIGRyaWZ0X3RocmVzaG9sZDogZmxvYXQsCiAgICBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ6IGZsb2F0LAogICAgaW5mX2NhcHBpbmc6IGZsb2F0LAopIC0+IFR1cGxlW0FydGlmYWN0LCBBcnRpZmFjdCwgZGljdF06CiAgICAiIiIKICAgIFBlcmZvcm0gZHJpZnQgYW5hbHlzaXMsIHByb2R1Y2luZyB0aGUgZHJpZnQgdGFibGUgYXJ0aWZhY3QgZm9yIGxvZ2dpbmcgcG9zdCBwcmVkaWN0aW9uLgoKICAgIDpwYXJhbSBmZWF0dXJlczogICAgICAgICAgICAgICAgIFRoZSBmZWF0dXJlcyBuYW1lcy4KICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgICAgICAgICAgIFRoZSBsYWJlbHMgbmFtZXMuCiAgICA6cGFyYW0gc2FtcGxlX3NldF9zdGF0aXN0aWNzOiAgICBUaGUgc3RhdGlzdGljcyBvZiB0aGUgc2FtcGxlIHNldCBsb2dnZWQgYWxvbmcgYSBtb2RlbC4KICAgIDpwYXJhbSBpbnB1dHM6ICAgICAgICAgICAgICAgICAgIElucHV0IGRhdGFzZXQgdG8gcGVyZm9ybSB0aGUgZHJpZnQgY2FsY3VsYXRpb24gb24uCiAgICA6cGFyYW0gd2VpZ2h0czogICAgICAgICAgICAgICAgICBXZWlnaHRzIGRpY3Rpb25hcnkuCiAgICA6cGFyYW0gZHJpZnRfdGhyZXNob2xkOiAgICAgICAgICBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgZHJpZnRzLgogICAgOnBhcmFtIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIHBvc3NpYmxlIGRyaWZ0cy4KICAgIDpwYXJhbSBpbmZfY2FwcGluZzogICAgICAgICAgICAgIFRoZSB2YWx1ZSB0byBzZXQgZm9yIHdoZW4gaXQgcmVhY2hlZCBpbmZpbml0eS4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZgogICAgICAgICAgICAgIFswXSA9IEFuIE1MUnVuIGFydGlmYWN0IGhvbGRpbmcgdGhlIEhUTUwgY29kZSBvZiB0aGUgZHJpZnQgdGFibGUgcGxvdC4KICAgICAgICAgICAgICBbMV0gPSBBbiBNTFJ1biBhcnRpZmFjdCBob2xkaW5nIHRoZSBtZXRyaWMgcGVyIGZlYXR1cmUgZGljdGlvbmFyeS4KICAgICAgICAgICAgICBbMl0gPSBSZXN1bHRzIHRvIGxvZyB0aGUgZmluYWwgYW5hbHlzaXMgb3V0Y29tZS4KICAgICIiIgogICAgIyBDYWxjdWxhdGUgdGhlIGlucHV0J3Mgc3RhdGlzdGljczoKICAgIGlucHV0c19zdGF0aXN0aWNzID0gY2FsY3VsYXRlX2lucHV0c19zdGF0aXN0aWNzKAogICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcz1zYW1wbGVfc2V0X3N0YXRpc3RpY3MsCiAgICAgICAgaW5wdXRzPWlucHV0cywKICAgICkKCiAgICAjIENhbGN1bGF0ZSBkcmlmdDoKICAgIHZpcnR1YWxfZHJpZnQgPSBWaXJ0dWFsRHJpZnQoaW5mX2NhcHBpbmc9aW5mX2NhcHBpbmcpCiAgICBtZXRyaWNzID0gdmlydHVhbF9kcmlmdC5jb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcygKICAgICAgICBmZWF0dXJlX3N0YXRzPXNhbXBsZV9zZXRfc3RhdGlzdGljcywKICAgICAgICBjdXJyZW50X3N0YXRzPWlucHV0c19zdGF0aXN0aWNzLAogICAgKQogICAgZHJpZnRfcmVzdWx0cyA9IHZpcnR1YWxfZHJpZnQuY2hlY2tfZm9yX2RyaWZ0X3Blcl9mZWF0dXJlKAogICAgICAgIG1ldHJpY3NfcmVzdWx0c19kaWN0aW9uYXJ5PW1ldHJpY3MsCiAgICAgICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkPXBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZCwKICAgICAgICBkcmlmdF9kZXRlY3RlZF90aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgKQoKICAgICMgVmFsaWRhdGUgYWxsIGZlYXR1cmUgY29sdW1ucyBuYW1lZCB0aGUgc2FtZSBiZXR3ZWVuIHRoZSBpbnB1dHMgYW5kIHNhbXBsZSBzZXRzOgogICAgc2FtcGxlX2NvbHVtbnMgPSBzZXQoCiAgICAgICAgWwogICAgICAgICAgICBjb2x1bW5fbmFtZQogICAgICAgICAgICBmb3IgY29sdW1uX25hbWUsIGNvbHVtbl9zdGF0aXN0aWNzIGluIHNhbXBsZV9zZXRfc3RhdGlzdGljcy5pdGVtcygpCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY29sdW1uX3N0YXRpc3RpY3MsIGRpY3QpCiAgICAgICAgXQogICAgKQogICAgaW5wdXRfY29sdW1ucyA9IHNldChpbnB1dHMuY29sdW1ucykKICAgIGlmIGxlbihzYW1wbGVfY29sdW1ucyAmIGlucHV0X2NvbHVtbnMpICE9IGxlbihpbnB1dF9jb2x1bW5zKToKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJOb3QgYWxsIGNvbHVtbiBuYW1lcyAoZmVhdHVyZXMgYW5kIGxhYmVscykgd2VyZSBtYXRjaGluZyBiZXR3ZWVuIHRoZSBpbnB1dHMgYW5kIHRoZSBzYW1wbGUgc2V0IHByb3ZpZGVkOiAiCiAgICAgICAgICAgIGYie2lucHV0X2NvbHVtbnMgLSBzYW1wbGVfY29sdW1ucyB8IHNhbXBsZV9jb2x1bW5zIC0gaW5wdXRfY29sdW1uc30iCiAgICAgICAgKQoKICAgICMgUGxvdDoKICAgIGh0bWxfcGxvdCA9IEZlYXR1cmVzRHJpZnRUYWJsZVBsb3QoKS5wcm9kdWNlKAogICAgICAgIGZlYXR1cmVzPWxpc3QoaW5wdXRfY29sdW1ucyksCiAgICAgICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzPXNhbXBsZV9zZXRfc3RhdGlzdGljcywKICAgICAgICBpbnB1dHNfc3RhdGlzdGljcz1pbnB1dHNfc3RhdGlzdGljcywKICAgICAgICBtZXRyaWNzPW1ldHJpY3MsCiAgICAgICAgZHJpZnRfcmVzdWx0cz1kcmlmdF9yZXN1bHRzLAogICAgKQoKICAgICMgUHJlcGFyZSBtZXRyaWNzIHBlciBmZWF0dXJlIGRpY3Rpb25hcnk6CiAgICBtZXRyaWNzX3Blcl9jb2x1bW4gPSB7CiAgICAgICAgY29sdW1uOiAobWV0cmljX2RpY3Rpb25hcnlbInR2ZCJdICsgbWV0cmljX2RpY3Rpb25hcnlbImhlbGxpbmdlciJdKSAvIDIKICAgICAgICBmb3IgY29sdW1uLCBtZXRyaWNfZGljdGlvbmFyeSBpbiBtZXRyaWNzLml0ZW1zKCkKICAgICAgICBpZiBpc2luc3RhbmNlKG1ldHJpY19kaWN0aW9uYXJ5LCBkaWN0KQogICAgfQoKICAgICMgUGFyc2UgdGhlIHdlaWdodHM6CiAgICB3ZWlnaHRzID0gX3BhcnNlX3dlaWdodHMoZmVhdHVyZXM9ZmVhdHVyZXMsIGxhYmVscz1sYWJlbHMsIHdlaWdodHM9d2VpZ2h0cykKCiAgICAjIENhbGN1bGF0ZSB0aGUgZmluYWwgYW5hbHlzaXMgcmVzdWx0OgogICAgcmVzdWx0cyA9IHt9CiAgICAoCiAgICAgICAgcmVzdWx0c1siZmVhdHVyZXNfZHJpZnRfc3RhdHVzIl0sCiAgICAgICAgcmVzdWx0c1siZmVhdHVyZXNfZHJpZnRfbWV0cmljIl0sCiAgICApID0gX2NhbGN1bGF0ZV9maW5hbF9zY29yZSgKICAgICAgICBjb2x1bW5zPWZlYXR1cmVzLAogICAgICAgIGRyaWZ0X3Jlc3VsdHM9bWV0cmljc19wZXJfY29sdW1uLAogICAgICAgIHdlaWdodHM9d2VpZ2h0cywKICAgICAgICB0aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgKQogICAgaWYgbGFiZWxzOgogICAgICAgICgKICAgICAgICAgICAgcmVzdWx0c1sibGFiZWxzX2RyaWZ0X3N0YXR1cyJdLAogICAgICAgICAgICByZXN1bHRzWyJsYWJlbHNfZHJpZnRfbWV0cmljIl0sCiAgICAgICAgKSA9IF9jYWxjdWxhdGVfZmluYWxfc2NvcmUoCiAgICAgICAgICAgIGNvbHVtbnM9ZmVhdHVyZXMsCiAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdHM9bWV0cmljc19wZXJfY29sdW1uLAogICAgICAgICAgICB3ZWlnaHRzPXdlaWdodHMsCiAgICAgICAgICAgIHRocmVzaG9sZD1kcmlmdF90aHJlc2hvbGQsCiAgICAgICAgKQoKICAgIHJldHVybiAoCiAgICAgICAgQXJ0aWZhY3QoYm9keT1odG1sX3Bsb3QsIGZvcm1hdD0iaHRtbCIsIGtleT0iZHJpZnRfdGFibGVfcGxvdCIpLAogICAgICAgIEFydGlmYWN0KAogICAgICAgICAgICBib2R5PWpzb24uZHVtcHMobWV0cmljc19wZXJfY29sdW1uKSwKICAgICAgICAgICAgZm9ybWF0PSJqc29uIiwKICAgICAgICAgICAga2V5PSJmZWF0dXJlc19kcmlmdF9yZXN1bHRzIiwKICAgICAgICApLAogICAgICAgIHJlc3VsdHMsCiAgICApCgoKIyBUT0RPOiBBZGQgYSBzdHJpbmcgb3B0aW9uIGZvciBgd2VpZ2h0c2AgcGFyYW1ldGVyOiBgImZlYXR1cmUtaW1wb3J0YW5jZSJgIHRvIHVzZSB0aGUgbW9kZWwncyBmZWF0dXJlIGltcG9ydGFuY2UgYXMKIyAgICAgICB3ZWlnaHRzLiBPbmx5IHBvc3NpYmxlIGlmIHRoZSBtb2RlbCBoYXMgYSBmZWF0dXJlIGltcG9ydGFuY2UgYXR0cmlidXRlLiBJZiB0aGUgbW9kZWwgZG9lc24ndCBoYXZlIGZlYXR1cmUKIyAgICAgICBpbXBvcnRhbmNlIGF0dHJpYnV0ZSwgYSB3YXJuaW5nIHdpbGwgYmUgc2hvd24gYW5kIG5vIHdlaWdodHMgd2lsbCBiZSBhcHBsaWVkLgpkZWYgaW5mZXIoCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIG1vZGVsOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhc2V0VHlwZSwKICAgIGRyb3BfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl0sIGludCwgTGlzdFtpbnRdXSA9IE5vbmUsCiAgICBsYWJlbF9jb2x1bW5zOiBVbmlvbltzdHIsIExpc3Rbc3RyXV0gPSBOb25lLAogICAgbG9nX3Jlc3VsdF9zZXQ6IGJvb2wgPSBUcnVlLAogICAgcmVzdWx0X3NldF9uYW1lOiBzdHIgPSAicHJlZGljdGlvbiIsCiAgICBiYXRjaF9pZDogc3RyID0gTm9uZSwKICAgIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6IGJvb2wgPSBOb25lLAogICAgc2FtcGxlX3NldDogRGF0YXNldFR5cGUgPSBOb25lLAogICAgd2VpZ2h0czogRGljdFtzdHIsIGZsb2F0XSA9IE5vbmUsCiAgICBkcmlmdF90aHJlc2hvbGQ6IGZsb2F0ID0gMC43LAogICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkOiBmbG9hdCA9IDAuNSwKICAgIGluZl9jYXBwaW5nOiBmbG9hdCA9IDEwLjAsCiAgICBhcnRpZmFjdHNfdGFnOiBzdHIgPSAiIiwKICAgICoqcHJlZGljdF9rd2FyZ3M6IERpY3Rbc3RyLCBBbnldLAopOgogICAgIiIiCiAgICBQZXJmb3JtIGEgcHJlZGljdGlvbiBvbiBhIGdpdmVuIGRhdGFzZXQgd2l0aCB0aGUgZ2l2ZW4gbW9kZWwuIENhbiBwZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIGJldHdlZW4gdGhlIHNhbXBsZSBzZXQKICAgIHN0YXRpc3RpY3Mgc3RvcmVkIGluIHRoZSBtb2RlbCB0byB0aGUgY3VycmVudCBpbnB1dCBkYXRhLiBUaGUgZHJpZnQgcnVsZSBpcyB0aGUgdmFsdWUgcGVyLWZlYXR1cmUgbWVhbiBvZiB0aGUgVFZECiAgICBhbmQgSGVsbGluZ2VyIHNjb3JlcyBhY2NvcmRpbmcgdG8gdGhlIHRocmVzaG9sZHMgY29uZmlndXJlcyBoZXJlLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgIE1MUnVuIGNvbnRleHQuCiAgICA6cGFyYW0gbW9kZWw6ICAgICAgICAgICAgICAgICAgICBUaGUgbW9kZWwgU3RvcmUgcGF0aC4KICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgICAgICAgIFRoZSBkYXRhc2V0IHRvIGluZmVyIHRocm91Z2ggdGhlIG1vZGVsLiBDYW4gYmUgcGFzc2VkIGluIGBpbnB1dHNgIGFzIGVpdGhlciBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEYXRhc2V0IGFydGlmYWN0IC8gRmVhdHVyZSB2ZWN0b3IgVVJJLiBPciwgaW4gYHBhcmFtZXRlcnNgIGFzIGEgbGlzdCwgZGljdGlvbmFyeSBvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtcHkgYXJyYXkuCiAgICA6cGFyYW0gZHJvcF9jb2x1bW5zOiAgICAgICAgICAgICBBIHN0cmluZyAvIGludGVnZXIgb3IgYSBsaXN0IG9mIHN0cmluZ3MgLyBpbnRlZ2VycyB0aGF0IHJlcHJlc2VudCB0aGUgY29sdW1uIG5hbWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvIGluZGljZXMgdG8gZHJvcC4gV2hlbiB0aGUgZGF0YXNldCBpcyBhIGxpc3Qgb3IgYSBudW1weSBhcnJheSB0aGlzIHBhcmFtZXRlciBtdXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZSByZXByZXNlbnRlZCBieSBpbnRlZ2Vycy4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW5zOiAgICAgICAgICAgIFRoZSB0YXJnZXQgbGFiZWwocykgb2YgdGhlIGNvbHVtbihzKSBpbiB0aGUgZGF0YXNldCBmb3IgUmVncmVzc2lvbiBvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2xhc3NpZmljYXRpb24gdGFza3MuIFRoZSBsYWJlbCBjb2x1bW4gY2FuIGJlIGFjY2Vzc2VkIGZyb20gdGhlIG1vZGVsIG9iamVjdCwgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBmZWF0dXJlIHZlY3RvciBwcm92aWRlZCBpZiBhdmFpbGFibGUuCiAgICA6cGFyYW0gbG9nX3Jlc3VsdF9zZXQ6ICAgICAgICAgICBXaGV0aGVyIHRvIGxvZyB0aGUgcmVzdWx0IHNldCAtIGEgRGF0YUZyYW1lIG9mIHRoZSBnaXZlbiBpbnB1dHMgY29uY2F0ZW5hdGVkIHdpdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBwcmVkaWN0aW9ucy4gRGVmYXVsdGVkIHRvIFRydWUuCiAgICA6cGFyYW0gcmVzdWx0X3NldF9uYW1lOiAgICAgICAgICBUaGUgZGIga2V5IHRvIHNldCBuYW1lIG9mIHRoZSBwcmVkaWN0aW9uIHJlc3VsdCBhbmQgdGhlIGZpbGVuYW1lLiBEZWZhdWx0ZWQgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwcmVkaWN0aW9uJy4KICAgIDpwYXJhbSBiYXRjaF9pZDogICAgICAgICAgICAgICAgIFRoZSBJRCBvZiB0aGUgZ2l2ZW4gYmF0Y2ggKGluZmVyZW5jZSBkYXRhc2V0KS4gSWYgYE5vbmVgLCBpdCB3aWxsIGJlIGdlbmVyYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdpbGwgYmUgbG9nZ2VkIGFzIGEgcmVzdWx0IG9mIHRoZSBydW4uCiAgICA6cGFyYW0gcGVyZm9ybV9kcmlmdF9hbmFseXNpczogICBXaGV0aGVyIHRvIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYmV0d2VlbiB0aGUgc2FtcGxlIHNldCBvZiB0aGUgbW9kZWwgb2JqZWN0IHRvIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldCBnaXZlbi4gQnkgZGVmYXVsdCwgTm9uZSwgd2hpY2ggbWVhbnMgaXQgd2lsbCBwZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIGlmIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgaGFzIGEgc2FtcGxlIHNldCBzdGF0aXN0aWNzLiBQZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIHdpbGwgcHJvZHVjZSBhIGRhdGEgZHJpZnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlIGFydGlmYWN0LgogICAgOnBhcmFtIHNhbXBsZV9zZXQ6ICAgICAgICAgICAgICAgQSBzYW1wbGUgZGF0YXNldCB0byBnaXZlIHRvIGNvbXBhcmUgdGhlIGlucHV0cyBpbiB0aGUgZHJpZnQgYW5hbHlzaXMuIFRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9zZW4gc2FtcGxlIHNldCB3aWxsIGFsd2F5cyBiZSB0aGUgb25lIHdobyBpcyBzZXQgaW4gdGhlIG1vZGVsIGFydGlmYWN0IGl0c2VsZi4KICAgIDpwYXJhbSB3ZWlnaHRzOiAgICAgICAgICAgICAgICAgIEEgZGljdGlvbmFyeSBvZiBmZWF0dXJlIG5hbWVzIGtleXMgKGBzdHJgKSBhbmQgdGhlaXIgd2VpZ2h0cyBhcyB2YWx1ZXMgKGBmbG9hdGApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBhcHBseSBvbiB0aGUgZHJpZnQgcmVzdWx0cy4gYE5vbmVgIG1lYW5zIG5vIHdlaWdodHMgYXJlIHVzZWQgYW5kIGV2ZXJ5IGZlYXR1cmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgaGF2ZSBhbiBlcXVhbCBzYXkgaW4gdGhlIGZpbmFsIHNjb3JlIChhIHNpbXBsZSBhdmVyYWdlKS4gRGVmYXVsdDogTm9uZS4KICAgIDpwYXJhbSBkcmlmdF90aHJlc2hvbGQ6ICAgICAgICAgIFRoZSB0aHJlc2hvbGQgb2Ygd2hpY2ggdG8gbWFyayBkcmlmdHMuIERlZmF1bHRlZCB0byAwLjcuCiAgICA6cGFyYW0gcG9zc2libGVfZHJpZnRfdGhyZXNob2xkOiBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgcG9zc2libGUgZHJpZnRzLiBEZWZhdWx0ZWQgdG8gMC41LgogICAgOnBhcmFtIGluZl9jYXBwaW5nOiAgICAgICAgICAgICAgVGhlIHZhbHVlIHRvIHNldCBmb3Igd2hlbiBpdCByZWFjaGVkIGluZmluaXR5LiBEZWZhdWx0ZWQgdG8gMTAuMC4KICAgIDpwYXJhbSBhcnRpZmFjdHNfdGFnOiAgICAgICAgICAgIFRhZyB0byB1c2UgZm9yIGFsbCB0aGUgYXJ0aWZhY3RzIHJlc3VsdGVkIGZyb20gdGhlIGZ1bmN0aW9uLgogICAgIiIiCiAgICAjIExvYWRpbmcgdGhlIG1vZGVsOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkxvYWRpbmcgbW9kZWwuLi4iKQogICAgbW9kZWxfaGFuZGxlciA9IEF1dG9NTFJ1bi5sb2FkX21vZGVsKG1vZGVsX3BhdGg9bW9kZWwsIGNvbnRleHQ9Y29udGV4dCkKICAgIGlmIGxhYmVsX2NvbHVtbnMgaXMgTm9uZToKICAgICAgICBsYWJlbF9jb2x1bW5zID0gWwogICAgICAgICAgICBvdXRwdXQubmFtZSBmb3Igb3V0cHV0IGluIG1vZGVsX2hhbmRsZXIuX21vZGVsX2FydGlmYWN0LnNwZWMub3V0cHV0cwogICAgICAgIF0KCiAgICAjIEdldCBkYXRhc2V0IGJ5IG9iamVjdCwgVVJMIG9yIGJ5IEZlYXR1cmVWZWN0b3I6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9hZGluZyBkYXRhLi4uIikKICAgIHgsIGxhYmVsX2NvbHVtbnMgPSBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgICAgICBkYXRhc2V0PWRhdGFzZXQsCiAgICAgICAgbGFiZWxfY29sdW1ucz1sYWJlbF9jb2x1bW5zLAogICAgICAgIGRyb3BfY29sdW1ucz1kcm9wX2NvbHVtbnMsCiAgICApCgogICAgIyBQcmVkaWN0OgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkNhbGN1bGF0aW5nIHByZWRpY3Rpb24uLi4iKQogICAgeV9wcmVkID0gbW9kZWxfaGFuZGxlci5tb2RlbC5wcmVkaWN0KHgsICoqcHJlZGljdF9rd2FyZ3MpCgogICAgIyBQcmVwYXJlIHRoZSByZXN1bHQgc2V0OgogICAgcmVzdWx0X3NldCA9IF9wcmVwYXJlX3Jlc3VsdF9zZXQoeD14LCBsYWJlbF9jb2x1bW5zPWxhYmVsX2NvbHVtbnMsIHlfcHJlZD15X3ByZWQpCgogICAgIyBDaGVjayBmb3IgbG9nZ2luZyB0aGUgcmVzdWx0IHNldDoKICAgIGlmIGxvZ19yZXN1bHRfc2V0OgogICAgICAgICMgTG9nIHRoZSByZXN1bHQgc2V0OgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJMb2dnaW5nIHJlc3VsdCBzZXQgKHggfCBwcmVkaWN0aW9uKS4uLiIpCiAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICAgICAga2V5PXJlc3VsdF9zZXRfbmFtZSwKICAgICAgICAgICAgZGY9cmVzdWx0X3NldCwKICAgICAgICAgICAgZGJfa2V5PXJlc3VsdF9zZXRfbmFtZSwKICAgICAgICAgICAgdGFnPWFydGlmYWN0c190YWcsCiAgICAgICAgKQogICAgICAgICMgTG9nIHRoZSBiYXRjaCBJRDoKICAgICAgICBpZiBiYXRjaF9pZCBpcyBOb25lOgogICAgICAgICAgICBiYXRjaF9pZCA9IGhhc2hsaWIuc2hhMjI0KHN0cihkYXRldGltZS5ub3coKSkuZW5jb2RlKCkpLmhleGRpZ2VzdCgpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KAogICAgICAgICAgICBrZXk9ImJhdGNoX2lkIiwKICAgICAgICAgICAgdmFsdWU9YmF0Y2hfaWQsCiAgICAgICAgKQoKICAgICMgQ2hlY2sgZm9yIHBlcmZvcm1pbmcgZHJpZnQgYW5hbHlzaXM6CiAgICBpZiAoCiAgICAgICAgcGVyZm9ybV9kcmlmdF9hbmFseXNpcyBpcyBOb25lCiAgICAgICAgYW5kIG1vZGVsX2hhbmRsZXIuX21vZGVsX2FydGlmYWN0LnNwZWMuZmVhdHVyZV9zdGF0cyBpcyBub3QgTm9uZQogICAgKToKICAgICAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzID0gVHJ1ZQogICAgaWYgcGVyZm9ybV9kcmlmdF9hbmFseXNpczoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJQZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzLi4uIikKICAgICAgICAjIEdldCB0aGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzIChlaXRoZXIgZnJvbSB0aGUgc2FtcGxlIHNldCBvciBmcm9tIHRoZSBzdGF0aXN0aWNzIGxvZ2dlZCB3aXRoIHRoZSBtb2RlbCk6CiAgICAgICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzID0gX2dldF9zYW1wbGVfc2V0X3N0YXRpc3RpY3MoCiAgICAgICAgICAgIHNhbXBsZV9zZXQ9c2FtcGxlX3NldCwKICAgICAgICAgICAgbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0cz1tb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLmZlYXR1cmVfc3RhdHMsCiAgICAgICAgKQogICAgICAgICMgR2V0IHRoZSBmZWF0dXJlcyBuYW1lczoKICAgICAgICBmZWF0dXJlcyA9IFsKICAgICAgICAgICAgZmVhdHVyZSBmb3IgZmVhdHVyZSBpbiByZXN1bHRfc2V0LmNvbHVtbnMgaWYgZmVhdHVyZSBub3QgaW4gbGFiZWxfY29sdW1ucwogICAgICAgIF0KICAgICAgICAjIFByb2R1Y2UgdGhlIGFydGlmYWN0czoKICAgICAgICAoCiAgICAgICAgICAgIGRyaWZ0X3RhYmxlX3Bsb3QsCiAgICAgICAgICAgIG1ldHJpY19wZXJfZmVhdHVyZV9kaWN0LAogICAgICAgICAgICBhbmFseXNpc19yZXN1bHRzLAogICAgICAgICkgPSBfcGVyZm9ybV9kcmlmdF9hbmFseXNpcygKICAgICAgICAgICAgZmVhdHVyZXM9ZmVhdHVyZXMsCiAgICAgICAgICAgIGxhYmVscz1sYWJlbF9jb2x1bW5zLAogICAgICAgICAgICBzYW1wbGVfc2V0X3N0YXRpc3RpY3M9c2FtcGxlX3NldF9zdGF0aXN0aWNzLAogICAgICAgICAgICBpbnB1dHM9cmVzdWx0X3NldCwKICAgICAgICAgICAgd2VpZ2h0cz13ZWlnaHRzLAogICAgICAgICAgICBkcmlmdF90aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgICAgICAgICBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ9cG9zc2libGVfZHJpZnRfdGhyZXNob2xkLAogICAgICAgICAgICBpbmZfY2FwcGluZz1pbmZfY2FwcGluZywKICAgICAgICApCiAgICAgICAgIyBMb2cgdGhlIGFydGlmYWN0IGFuZCByZXN1bHRzOgogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KGRyaWZ0X3RhYmxlX3Bsb3QsIHRhZz1hcnRpZmFjdHNfdGFnKQogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KG1ldHJpY19wZXJfZmVhdHVyZV9kaWN0LCB0YWc9YXJ0aWZhY3RzX3RhZykKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHRzKHJlc3VsdHM9YW5hbHlzaXNfcmVzdWx0cykK
    commands: []
    code_origin: https://github.com/guy1992l/functions.git#f55e6051f7e4c285b56bbc30e4846914435d77c6:/Users/Guy_Lecker/Projects/functions/batch_inference/batch_inference.py
    origin_filename: /Users/Guy_Lecker/Projects/functions/batch_inference/batch_inference.py
    with_mlrun: false
    auto_build: false
  entry_points:
    infer:
      name: infer
      doc: 'Perform a prediction on a given dataset with the given model. Can perform
        drift analysis between the sample set

        statistics stored in the model to the current input data. The drift rule is
        the value per-feature mean of the TVD

        and Hellinger scores according to the thresholds configures here.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: model
        type: str
        doc: The model Store path.
        default: ''
      - name: dataset
        type: DatasetType
        doc: The dataset to infer through the model. Can be passed in `inputs` as
          either a Dataset artifact / Feature vector URI. Or, in `parameters` as a
          list, dictionary or numpy array.
        default: ''
      - name: drop_columns
        type: Union[str, List[str], int, List[int]]
        doc: A string / integer or a list of strings / integers that represent the
          column names / indices to drop. When the dataset is a list or a numpy array
          this parameter must be represented by integers.
        default: null
      - name: label_columns
        type: Union[str, List[str]]
        doc: The target label(s) of the column(s) in the dataset for Regression or
          Classification tasks. The label column can be accessed from the model object,
          or the feature vector provided if available.
        default: null
      - name: log_result_set
        type: bool
        doc: Whether to log the result set - a DataFrame of the given inputs concatenated
          with the predictions. Defaulted to True.
        default: true
      - name: result_set_name
        type: str
        doc: The db key to set name of the prediction result and the filename. Defaulted
          to 'prediction'.
        default: prediction
      - name: batch_id
        type: str
        doc: The ID of the given batch (inference dataset). If `None`, it will be
          generated. Will be logged as a result of the run.
        default: null
      - name: perform_drift_analysis
        type: bool
        doc: Whether to perform drift analysis between the sample set of the model
          object to the dataset given. By default, None, which means it will perform
          drift analysis if the model has a sample set statistics. Perform drift analysis
          will produce a data drift table artifact.
        default: null
      - name: sample_set
        type: DatasetType
        doc: A sample dataset to give to compare the inputs in the drift analysis.
          The default chosen sample set will always be the one who is set in the model
          artifact itself.
        default: null
      - name: weights
        type: Dict[str, float]
        doc: 'A dictionary of feature names keys (`str`) and their weights as values
          (`float`) to apply on the drift results. `None` means no weights are used
          and every feature will have an equal say in the final score (a simple average).
          Default: None.'
        default: null
      - name: drift_threshold
        type: float
        doc: The threshold of which to mark drifts. Defaulted to 0.7.
        default: 0.7
      - name: possible_drift_threshold
        type: float
        doc: The threshold of which to mark possible drifts. Defaulted to 0.5.
        default: 0.5
      - name: inf_capping
        type: float
        doc: The value to set for when it reached infinity. Defaulted to 10.0.
        default: 10.0
      - name: artifacts_tag
        type: str
        doc: Tag to use for all the artifacts resulted from the function.
        default: ''
      outputs:
      - default: ''
      lineno: 355
  description: Batch inference (also knows as prediction) for the common ML frameworks
    (SciKit-Learn, XGBoost and LightGBM) while performing data drift analysis.
  default_handler: infer
  disable_auto_mount: false
  allow_empty_resources: true
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
